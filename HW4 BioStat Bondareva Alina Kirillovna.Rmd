---
title: "HW4 BioStatistic"
author: "Bondareva Alina Kirillovna"
date: "2024-04-02"
output: html_document
---

```{=html}
<style type="text/css">
body{
  font-family: Helvetica;
  font-size: 12pt;
}
/* Headers */
h1, h2{
  font-size: 16pt;
}
</style>
```
# Домашнее задание №4.

## Выполнила Бондарева Алина Кирилловна

**Тема:** использование основных статистических тестов и поправок на множественные сравнения.

**Цель:** разберем использование основных параметрических и непараметрических статистических тестов, научимся вводить поправки на множественные сравнения и поймем, чем они отличаются.

### **Задание 1**

Рассмотрите следующую статистическую гипотезу:

*Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.*

*Задайте `seed` для воспроизводимости результатов (функция `set.seed())`. Задайте размер выборки `sample_size <- 30`. Задайте значение среднего артериального давления до приема нового препарата и после.*

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.
-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.
-   Определите наблюдаемое значение статистики, а также критическое значение статистики.
-   Оцените и прокомментируйте статистическую значимость.

```{r}
# Импортируем необходимые библиотеки
library(ggplot2)
library(tidyverse)
library(dplyr)
library(tibble)
```

```{r, include=TRUE}
set.seed(123) # Устанавливаем seed для воспроизводимости
sample_size <- 30 # Размер выборки

# Генерируем данные (bp - blood pressure)
mean_bp_before <- 140
mean_bp_after <- 120

# Создаем набор данных для давления пациентов перед началом лечения, учитывая заданное отклонение
before_bp_sd <- 12
before_treatment_bp <- rnorm(n = sample_size, mean = mean_bp_before, sd = before_bp_sd)

# Создаем набор данных для давления пациентов после введения препарата с другим стандартным отклонением
after_bp_sd <- 10
after_treatment_bp <- rnorm(n = sample_size, mean = mean_bp_after, sd = after_bp_sd)

# Составляем датафрейм с измерениями до и после
blood_pressure_data <- data.frame(before_treatment = before_treatment_bp,
                                  after_treatment = after_treatment_bp)

# Предварительный просмотр данных
head(blood_pressure_data)
```

Теперь нам необходимо сформировать гипотезы:

`H0` - **Артериальное давление до и после приема препарата статистически значимо не отличаются;**

`H1` - **Артериальное давление до и после приема препарата статистически значимо отличается.**

В медицинских исследованиях обычно используется уровень значимости $$\alpha = 0.05$$, что означает, что вероятность отклонить нулевую гипотезу, когда она верна, составляет 5%.

Перед выбором статистических тестов, нам необходимо убедиться в нормальности распределения в выборках. Это можно сделать как с помощью визуальных методов, так и с помощью теста Манна-Уитни, например.

```{r, include = TRUE}
# Проанализируем распределение давления пациентов перед лечением с помощью визульаных методов - гистограммы

ggplot(blood_pressure_data, aes(x = before_treatment)) +
  geom_histogram(binwidth = 5, fill = "skyblue", color = "darkblue") +
  labs(title = "Распределение АД перед началом терапии", x = "Давление", y = "Количество наблюдений") +
  theme_light()
```

Распределение кажется нормальным, но с отклонениями в правом хвосте.

Посмотрим для второй выборки:

```{r, include=TRUE}
# Проанализируем распределение давления пациентов после леченя с помощью визульаных методов - гистограммы
ggplot(blood_pressure_data, aes(x = after_treatment)) +
  geom_histogram(binwidth = 4, fill = "aquamarine", color = "navy") +
  labs(title = "Анализ АД после терапии", x = "Уровень давления", y = "Плотность наблюдений") +
  theme_bw()
```

Это распределение совершенно точно отличается от нормального.

Давайте теперь проверим обе выборки с помощью теста Шапиро-Уилка для уверенности:

```{r, include=TRUE}
# Тест Шапиро-Уилка на нормальность
shapiro.test(blood_pressure_data$before_treatment)
shapiro.test(blood_pressure_data$after_treatment)
```

В итоге, мы видим что: `p-value = 0.7966` для выборки "перед началом терапии - `before_treatment`"

`p-value = 0.2432` для выборки "после лечения - `after_treatment`"

Таким образом, значение `p-value` выше установленного порога альфа ($$\alpha = 0.05$$) в обеих проверках, у нас нет оснований отклонять нулевую гипотезу. Значит, распределение значений по обеим выборкам соответствует нормальному, несмотря на визуальное отличие. Мы будем придерживаться этого вывода.

Теперь, после того, как мы доказали нормальность распределения, мы можем провести попарный t-тест для поиска статистически значимых различий в выборках.

```{r, include=TRUE}
t_test_result <- t.test(blood_pressure_data$before_treatment, blood_pressure_data$after_treatment, paired = TRUE)
print(t_test_result)
```

Результаты парного t-теста показывают статистически значимую разницу в артериальном давлении до и после лечения (p-value = 8.042e-07), что указывает на эффективность препарата. Среднее изменение артериального давления составило 17.65 единиц, с 95% доверительным интервалом от 11.88 до 23.43

Вычислим значение, превышающее которое различия считаются значимыми, для двустороннего теста с уровнем доверия 95%: (df - degrees of freedom, (что соответствует размеру выборки минус единица, sample_size - 1, для парного t-теста)

```{r, include=TRUE}
alpha = 0.05
critical_value <- qt(1 - alpha / 2, df = (sample_size - 1))

critical_value
```

Исходя из полученных данных, значение t-статистики (t = 6.2499) существенно выше, чем критическое значение (critical_value = 2.04523), заданное для 29 степеней свободы при уровне значимости 5%.

Так как значение `p_value` меньше уровня значимости `alpha`, мы отклоняем нулевую гипотезу (`H0`) в пользу альтернативной (`H1`), указывая на наличие статистически подтвержденного различия в уровнях артериального давления до и после лечения, что свидетельствует об эффективности препарата для понижения систолического давления.

Доверительный интервал для разности средних не охватывает нуль, дополнительно подтверждая статистическую значимость наблюдаемых различий.

### **Задание 2**

Рассмотрите следующую статистическую гипотезу.

Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2

Рассмотрите два случая: для выборки `sample_size1 <- 100` и выборки `sample_size2 <- 30`. Сгенерируйте данные по курению с помощью функции `rep()`, пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

Затем:

-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.
-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.
-   Определите наблюдаемое значение статистики, а также критическое значение статистики.
-   Оцените и прокомментируйте статистическую значимость.

```{r, include=TRUE}
set.seed(12) # Устанавливаем seed для воспроизводимости
sample_size1 <- 100 # Размер первой выборки

# Генерация первой выборки с помощью функции `rep()`, т.к. отношение числа курящих к некурящим в выборке составляет 1:1, то мы можем просто поделить пополам размер выборки, обеспечивания равное разделение векторов.
smoking_status1 <- rep(c("Курящий", "Некурящий"), each = sample_size1 / 2)

# Генерируем случайные данные о наличии рака легких у курящих в первой выборке, используя вероятность заболевания раком 0.8 из биноминального распределения `rbinom`
cancer_in_smokers1 <- rbinom(n = sample_size1 / 2, size = 1, prob = 0.8)

# Аналогично генерируем данные для некурящих в первой выборке с вероятностью заболевания 0.2
cancer_in_nonsmokers1 <- rbinom(n = sample_size1 / 2, size = 1, prob = 0.2)

# Объединяем данные о раке легких для курящих и некурящих в один вектор первой выборки
lung_cancer_case1 <- c(cancer_in_smokers1, cancer_in_nonsmokers1)

# Создаем датафрейм с информацией о курении и наличии рака легких первой выборки
data_sample1 <- data.frame(SmokingStatus = smoking_status1,
                           LungCancer = lung_cancer_case1)

# Выводим первые несколько строк датафрейма для предварительного просмотра
head(data_sample1)
```

```{r}
sample_size2 <- 30 # Размер второй выборки

# Генерация второй выборки с помощью функции `rep()`, т.к. отношение числа курящих к некурящим в выборке составляет 1:1, то мы можем просто поделить пополам размер выборки, обеспечивания равное разделение векторов.
smoking_status2 <- rep(c("Курящий", "Некурящий"), each = sample_size1 / 2)

# Генерируем случайные данные о наличии рака легких у курящих второй выборки, используя вероятность заболевания раком 0.8 из биноминального распределения `rbinom`
cancer_in_smokers2 <- rbinom(n = sample_size1 / 2, size = 1, prob = 0.8)

# Аналогично генерируем данные для некурящих второй выборки с вероятностью заболевания 0.2
cancer_in_nonsmokers2 <- rbinom(n = sample_size1 / 2, size = 1, prob = 0.2)

# Объединяем данные о раке легких для курящих и некурящих в один вектор второй выборки
lung_cancer_case2 <- c(cancer_in_smokers2, cancer_in_nonsmokers2)

# Создаем датафрейм с информацией о курении и наличии рака легких второй выборки
data_sample2 <- data.frame(SmokingStatus = smoking_status2,
                           LungCancer = lung_cancer_case2)

# Выводим первые несколько строк датафрейма для предварительного просмотра
head(data_sample2)
```

Сформулируем гипотезы:

`H0` - **Вероятность развития рака легких в обеих группах (курящие и некурящие) имеет статистически незначимую разницу**

`H1` - **В группе курящих риск развития рака легких статистически значимо выше, чем в группе некурящих**

Оставим уровень значимости таким же, как и в прошлой задаче $$ \alpha = 0.05 $$

Как и в прошлой задаче №1 начнем с визуального определения распределения в обеих выборках.

```{r, include=TRUE}
barplot(table(data_sample1$SmokingStatus, data_sample1$LungCancer), beside = TRUE,
        col = c("green", "brown"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Курящие", "Некурящие"), main = "Влияние курения на развитие рака легких (выбора№1 из 100 чел.)",
        ylab = "Число случаев")

```
```{r, include=TRUE}
barplot(table(data_sample2$SmokingStatus, data_sample2$LungCancer), beside = TRUE,
        col = c("green", "brown"), legend = c("Нет рака легких", "Рак легких"),
        names.arg = c("Курящие", "Некурящие"), main = "Влияние курения на развитие рака легких (выбора№2 из 30 чел.)",
        ylab = "Число случаев")

```
В итоге из графиков мы видим, что:
* Распределение случаев заболевания раком легких между курящими и некурящими группами неодинаково, согласно условиям задания;
* Оба рассматриваемых признака являются категориальными;
* Взаимное расположение данных указывает на их независимость;
* В меньшей выборке объемом в 30 человек наблюдается одинаковое малое количество случаев рака среди некурящих, также как и малое количество здоровых среди курящих.

Исходя из вышеперечисленного, для анализа данных мы отдадим предпочтение точному тесту Фишера, потому что при работе с категориальными переменными и сравнении долей внутри малых выборок тест Фишера является более подходящим, чем хи-квадрат тест, особенно когда количество наблюдений в какой-либо из ячеек таблицы сопряженности меньше 5. А также, точный тест Фишера позволяет точно вычислить p-value без применения приближенных методов, что делает его особенно ценным в анализе малых выборок, где другие методы могут давать неточные результаты.

```{r, include=TRUE}
# Применяем точный тест Фишера к первой выборке
fisher_test_sample1 <- fisher.test(table(data_sample1$SmokingStatus, data_sample1$LungCancer))

# Выводим результаты теста для первой выборки
print(fisher_test_sample1)

# Применяем точный тест Фишера ко второй выборке
fisher_test_sample2 <- fisher.test(table(data_sample2$SmokingStatus, data_sample2$LungCancer))

# Выводим результаты теста для второй выборки
print(fisher_test_sample2)

```
Давайте разберемся в результатах:

* **P-value:**  Очень маленькие значения p-value (2.528e-11 для выборки №1 из 100 наблюдений и 5.225e-09 для выборки №2 из 30) указывают на то, что различия в распределении случаев рака легких между курящими и некурящими статистически значимы. Это позволяет отвергнуть нулевую гипотезу `H0` и принять альтернативную `H1` о наличии связи между курением и раком легких.

* **Доверительный интервал для отношения шансов (odds ratio):** Доверительный интервал для отношения шансов показывает диапазон значений, в котором с определенной степенью уверенности (95%) находится истинное значение отношения шансов развития рака легких между курящими и некурящими. Отношение шансов меньше единицы в обеих выборках (0.04268653 для 100 наблюдений и 0.06562656 для 30 наблюдений), что указывает на то, что шансы развития рака легких значительно выше у курящих по сравнению с некурящими. Чем меньше значение отношения шансов, тем сильнее связь между курением и повышенным риском развития рака легких. В обеих выборках интервалы меньше единицы, что подтверждает статистическую значимость различия между группами - `H1`

Таким образом, результаты точного теста Фишера в обеих выборках ясно демонстрируют наличие статистически значимой связи между курением и увеличением риска развития рака легких, подтверждая эффективность теста Фишера для анализа такого рода данных.

### **Задание 3**

Рассмотрите следующую статистическую гипотезу.

Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.

Что нужно сделать:

* Сформулируйте нулевую и альтернативную гипотезы.
* Определите уровень значимости.
* Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.
* Определите наблюдаемое значение статистики, а также критическое значение статистики.
* Оцените и прокомментируйте статистическую значимость.

```{r, include=TRUE}
# Установка seed для воспроизводимости результатов
set.seed(123)

# Сгенерируем данные, исходя из предположения, что "уровень болевых симптомов" может быть количественно измерен от 0 до 10, где 0 - нет симптомов, 10 - максимальная интенсивность боли

# Размеры выборок
sample_size_new_treatment <- 100  # Для нового метода лечения
sample_size_dietotherapy <- 100  # Для диетотерапии

# Проведем генерацию уровней болевых симптомов для каждой группы с использованием нормального распределения
# Предположим, что средний уровень болевых симптомов для нового метода лечения ниже, чем для диетотерапии
mean_pain_new_treatment <- 3  # Среднее значение боли для группы нового лечения
mean_pain_dietotherapy <- 5   # Среднее значение боли для группы диетотерапии
std_dev_pain <- 2             # Стандартное отклонение уровня боли в обеих группах

# Генерация данных
pain_levels_new_treatment <- rnorm(sample_size_new_treatment, mean = mean_pain_new_treatment, sd = std_dev_pain)
pain_levels_dietotherapy <- rnorm(sample_size_dietotherapy, mean = mean_pain_dietotherapy, sd = std_dev_pain)

# Ограничение значений диапазоном от 0 до 10 и округление до целых чисел
pain_levels_new_treatment <- round(pmin(pmax(pain_levels_new_treatment, 0), 10))
pain_levels_dietotherapy <- round(pmin(pmax(pain_levels_dietotherapy, 0), 10))

# Объединим в один датасет
treatment_irritable_bowel_syndrome <- data.frame(New_method = pain_levels_new_treatment,
                            Dietotherapy = pain_levels_dietotherapy)
# Смотрим на результат
head(treatment_irritable_bowel_syndrome)
```
Теперь сформулируем гипотезы:

`H0`: Новый метод лечения синдрома раздраженного кишечника не влияет на уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

`H1`: Новый метод лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с диетотерапией.

Оставим уровень значимости таким же, как и в прошлых задачах $$ \alpha = 0.05 $$

Проверим распределение с помощью визуальных методов ggplot2: чтобы визуализировать данные из этого датафрейма, нам всё же нужно привести его к "длинному" формату, так как ggplot2 работает с данными в таком формате лучше.

```{r, include=TRUE}
# Преобразуем датафрейм в длинный формат
pain_data_tibs_long <- pivot_longer(treatment_irritable_bowel_syndrome, 
                          cols = c(New_method, Dietotherapy), 
                          names_to = "Treatment", 
                          values_to = "Pain_Level")

# Теперь создадим гистограмму
ggplot(pain_data_tibs_long, aes(x = Pain_Level, fill = Treatment)) +
  geom_histogram(position = "dodge", binwidth = 1) +
  scale_fill_manual(values = c("New_method" = "lightblue", "Dietotherapy" = "lightgreen")) +
  labs(title = "Уровни болевых симптомов по методам лечения синдрома раздраженного кишечника",
       x = "Уровень болевых симптомов", y = "Частота", fill = "Метод лечения") +
  theme_minimal()
```
Теперь проведем тест Шапиро-Уилка и проверим нормальность распредедения:

```{r, include=TRUE}
shapiro.test(treatment_irritable_bowel_syndrome$New_method) 
shapiro.test(treatment_irritable_bowel_syndrome$Dietotherapy)
```
Мы видим, что в обоих выборках `p_value < alpha` - это дает основание пологать, что распределение действительно нормальное в обеиъ выборках.

Так как у нас нормальное распределение, мы можем использовать t-тест для проверки гипотезы о значимом изменении уровня болевых симптомов между группой, прошедшей новое лечение `New_Method` синдрома раздраженного кишечника, и группой, прошедшей лечение диетотерапией `Dietotherapy`

```{r, include=TRUE}
# Проведение двухвыборочного t-теста для независимых выборок
t_test_result <- t.test(pain_levels_new_treatment, pain_levels_dietotherapy)

# Вывод результатов теста
print(t_test_result)

```
```{r, include=TRUE}
critical_value <- qt(0.975, df = 196.18)  # Для двустороннего t-теста с альфа = 0.05
critical_value
```
* **P-value:** Значение p-value, составляющее 1.86e-08, подтверждает наличие статистически значимой разницы в средних уровнях болевых симптомов между пациентами, принимавшими участие в испытании нового метода лечения синдрома раздраженного кишечника, и теми, кто подвергался диетотерапии. Такая малая величина p-value даёт основания отклонить нулевую гипотезу (`H0`) в пользу альтернативной (`H1`), свидетельствуя о том, что введение нового метода лечения приводит к значительному улучшению состояния пациентов по сравнению с диетотерапией.

* **Доверительный интервал для разности средних:** Установленный доверительный интервал разности средних, охватывающий от -2.030927 до -1.009073 и не включающий в себя ноль, ещё раз подчёркивает статистическую значимость отмеченных различий. Отрицательные значения интервала подтверждают, что средний уровень болевых симптомов у группы, получившей новое лечение (в среднем 3.24), оказался ниже по сравнению с группой, проходившей диетотерапию (в среднем 4.76).

* **Наблюдаемое значение статистики (t-значение) и критическое значение:** Значение t-статистики, равное -5.8671, и степени свободы (df), равные 196.18, указывают на большую разницу между средними значениями двух групп, превышающую ожидаемую вариативность в рамках этих групп. При уровне значимости 0.05 и данных степенях свободы критическое значение t-статистики для двустороннего теста обычно находится в диапазоне около ±1.96. Наблюдаемое значение t-статистики значительно превышает этот порог, что дополнительно подтверждает статистическую значимость различий между группами.

Таким образом, исходя из результатов t-теста, можно делать вывод о значимом положительном эффекте нового метода лечения на уменьшение болевых симптомов синдрома раздраженного кишечника по сравнению с диетотерапией.

### **Задание 4**

Рассмотрите следующую гипотезу.

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей. Оценивается размер опухоли у мыши.

Сгенерируйте датасет следующим образом:
```{r, include=TRUE}
# Создание датафрейма
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))

tumor$value <- tumor$value + rnorm(30, 0, 760)
```

* Постройте на одном графике три «ящика с усами» для наглядности.
* Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. 
* Прокомментируйте получившийся результат.
* С помощью функции `TukeyHSD()` проведите попарные сравнения, используя критерий Тьюки.
* Прокомментируйте полученные результаты.

Визуализация данных с помощью "ящика с усами"
```{r, include=TRUE}
ggplot(tumor, aes(x = therapy, y = value, fill = therapy)) +
  geom_boxplot() +
  labs(title = "Размер опухоли по группам терапии", x = "Группа терапии", y = "Размер опухоли") +
  theme_minimal()
```
Проведем дисперсионный анализ (ANOVA), чтобы выяснить, есть ли разница между размером опухоли во всех группах.
```{r, include=TRUE}
# Проведение ANOVA
anova_result <- aov(value ~ therapy, data = tumor)
summary(anova_result)

```
Результаты дисперсионного анализа (ANOVA) показывают наличие статистически значимых различий в размерах опухолей между группами мышей, получавших различные противоопухолевые препараты и плацебо.

* **F-value:** Значение F-value составляет 4.399, что указывает на то, что между средними размерами опухолей в различных группах терапии существует различие.

* **P-value:** Со значением p-value равным 0.0222, которое меньше стандартного порога значимости 0.05, мы имеем основания отвергнуть нулевую гипотезу о том, что все группы имеют одинаковые средние размеры опухолей. Это указывает на то, что по меньшей мере один из препаратов A или B значимо отличается от плацебо (или же препараты отличаются друг от друга) по эффективности влияния на размер опухоли.

Дисперсионный анализ не указывает, какие именно группы различаются, только подтверждает факт наличия этих различий. Для выяснения более конкретных парных различий между группами требуются дополнительные анализы, например, с использованием критерия Тьюки.

Проведем попарные сравнения с использования критерия Тьюки:
```{r, include=TRUE}
# Попарные сравнения с критерием Тьюки
tukey_result <- TukeyHSD(anova_result)
tukey_result

```
Результаты попарного сравнения с использованием критерия Тьюки показывают следующее:

* **1. Группа B (препарат B)** имеет статистически значимо меньший размер опухоли по сравнению с группой плацебо (0). Разница в средних значениях составляет -890.9976, с доверительным интервалом [-1675.9486, -106.04653] и p-adj (p-value) равным 0.0237. Это означает, что препарат B значимо эффективнее плацебо в уменьшении размера опухоли, так как `p-value < alpha`.

* **2. Группа A (препарат A)** не показала статистически значимых различий в размере опухоли по сравнению с группой плацебо (0). Разница в средних значениях составляет -188.6284, с доверительным интервалом [-973.5794, 596.32264] и p-adj равным 0.8235. Это означает, что препарат A не отличается от плацебо по эффективности.

* **3. Сравнение между группами A и B** не показало статистически значимых различий в размере опухоли. Разница в средних значениях составляет -702.3692, с доверительным интервалом [-1487.3202, 82.58188] и p-adj равным 0.0860.

Таким образом, на основании результатов попарного сравнения можно сделать вывод, что препарат B значимо эффективнее плацебо в уменьшении размера опухоли, в то время как препарат A не показал статистически значимого улучшения по сравнению с плацебо. Не выявлено статистически значимых различий между препаратами A и B.



